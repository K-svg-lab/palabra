<!DOCTYPE html>
<html>
<head>
  <title>Debug: Check Offline Queue</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <h1>Offline Queue & Stats Inspector</h1>
  <button onclick="checkQueue()">Check Offline Queue</button>
  <button onclick="checkStats()">Check Today's Stats</button>
  <button onclick="checkReviews()">Check Reviews</button>
  <button onclick="processQueue()">Process Queue</button>
  <div id="output"></div>

  <script type="module">
    import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@7/+esm';

    async function getDB() {
      return await openDB('palabra_db', 5, {
        upgrade(db) {
          // Schema will exist if app has been opened
        },
      });
    }

    window.checkQueue = async function() {
      try {
        const db = await getDB();
        const queue = await db.getAll('offlineQueue');
        
        document.getElementById('output').innerHTML = `
          <h2>Offline Queue (${queue.length} items)</h2>
          <pre>${JSON.stringify(queue, null, 2)}</pre>
        `;
      } catch (error) {
        document.getElementById('output').innerHTML = `
          <p class="error">Error: ${error.message}</p>
        `;
      }
    };

    window.checkStats = async function() {
      try {
        const db = await getDB();
        const stats = await db.getAll('stats');
        const today = new Date().toISOString().split('T')[0];
        const todayStats = stats.find(s => s.date === today);
        
        document.getElementById('output').innerHTML = `
          <h2>Today's Stats (${today})</h2>
          <pre>${JSON.stringify(todayStats, null, 2)}</pre>
          <h2>All Stats (${stats.length} days)</h2>
          <pre>${JSON.stringify(stats.slice(-7), null, 2)}</pre>
        `;
      } catch (error) {
        document.getElementById('output').innerHTML = `
          <p class="error">Error: ${error.message}</p>
        `;
      }
    };

    window.checkReviews = async function() {
      try {
        const db = await getDB();
        const reviews = await db.getAll('reviews');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const todayReviews = reviews.filter(r => {
          if (!r.lastReviewDate) return false;
          const reviewDate = new Date(r.lastReviewDate);
          return reviewDate >= today;
        });
        
        document.getElementById('output').innerHTML = `
          <h2>Today's Reviews (${todayReviews.length} items)</h2>
          <pre>${JSON.stringify(todayReviews.slice(0, 10), null, 2)}</pre>
          <h2>Total Reviews: ${reviews.length}</h2>
        `;
      } catch (error) {
        document.getElementById('output').innerHTML = `
          <p class="error">Error: ${error.message}</p>
        `;
      }
    };

    window.processQueue = async function() {
      document.getElementById('output').innerHTML = '<p>Processing queue...</p>';
      try {
        const response = await fetch('/api/sync/process-queue', {
          method: 'POST',
          credentials: 'include',
        });
        
        if (response.ok) {
          const result = await response.json();
          document.getElementById('output').innerHTML = `
            <p class="success">Queue processed successfully!</p>
            <pre>${JSON.stringify(result, null, 2)}</pre>
          `;
        } else {
          document.getElementById('output').innerHTML = `
            <p class="error">Failed to process queue: ${response.statusText}</p>
          `;
        }
      } catch (error) {
        document.getElementById('output').innerHTML = `
          <p class="error">Error: ${error.message}</p>
        `;
      }
    };

    // Auto-check on load
    window.addEventListener('load', () => {
      checkQueue();
    });
  </script>
</body>
</html>
