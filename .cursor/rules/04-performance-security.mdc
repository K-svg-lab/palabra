---
globs: ['**/*']
---

# Performance & Security

## Performance Philosophy
App feels instant. <100ms interaction response. <2s page load on 3G.

## Performance Targets

### Core Web Vitals (All Green)
- LCP < 2.5s
- FID < 100ms
- CLS < 0.1
- INP < 200ms
- TTFB < 600ms

### Additional
- FCP < 1.5s, TTI < 3.5s on 3G
- Bundle < 200KB gzipped
- Lighthouse 90+ all categories

## Loading Performance

### Critical Path
1. Critical CSS (inline), 2. Critical JS (defer), 3. Critical Content (LCP), 4. Secondary (lazy)

### Code Splitting
Route-based automatic, Component >50KB, Vendor separate

### Image/Font
- Next.js Image: WebP/AVIF, lazy, blur placeholder
- Fonts: Self-host, `font-display: swap`, subset, preload

### Prefetch
Next.js Link automatic, preload audio, TanStack Query prefetch

## Runtime Performance

### React/JavaScript
- Memoize when profiled, split large components, virtualize lists
- Debounce search (300ms), keep main thread free (<50ms)
- Efficient algorithms, cache values

### Network
Bundle assets, batch API calls, paginate (10-20), caching headers

## Caching Strategy

### Browser
- Static: `max-age=31536000, immutable`
- HTML: `s-maxage=60, stale-while-revalidate=300`
- API: `private, no-cache`

### TanStack Query
```typescript
staleTime: 5min, cacheTime: 10min,
refetchOnWindowFocus: true
```

### Service Worker
- Cache First: UI assets
- Network First: API calls
- Stale While Revalidate: Images

## Database Performance

### Optimization
- Index frequent queries
- Avoid N+1 (use JOINs)
- Paginate results
- Database functions for aggregations

## PWA Performance

### Offline
- Cache: App shell, vocabulary, reviews
- Sync: Queue mutations, sync on reconnect

## Security Principles

### Authentication
- Never trust client
- Validate JWT every request
- Check permissions in database (RLS)

### Session
- httpOnly cookies (XSS protection)
- Secure flag (HTTPS)
- SameSite=Lax (CSRF)
- Short expiry (1h), refresh tokens

### Row Level Security
Database enforces access control

```sql
CREATE POLICY "Users view own vocab" ON vocabulary
  FOR SELECT USING (auth.uid() = user_id);
```

### Input Validation
**Client** (UX): Zod schemas
**Server** (Security): Always validate again
**SQL Injection**: Parameterized queries

### XSS Prevention
- React escapes by default
- Avoid `dangerouslySetInnerHTML`
- If needed: Sanitize with DOMPurify
- Content Security Policy

### CSRF Prevention
- SameSite cookies
- Server Actions: Automatic protection

### Data Privacy
**Encryption**:
- At Rest: PostgreSQL (Supabase default)
- In Transit: HTTPS, TLS 1.3

**Sensitive Data**:
- Never log passwords/tokens
- Environment variables for secrets
- Rotate keys regularly

### API Security
- Rate limiting (100 req/min per IP)
- API keys server-side only
- CORS: Restrict to domain

### Dependencies
```bash
npm audit        # Check vulnerabilities
npm update       # Update deps
```
- Automated: Dependabot
- Lock: package-lock.json

## Environment Variables
**Never Commit Secrets**:
- `.env.local` (gitignored)
- `.env.example` (committed, no values)
- Separate keys: Dev, Staging, Prod
- Vercel: Dashboard (encrypted)

## Monitoring

### Error Tracking
Sentry: Client/server errors, performance

### Analytics
Vercel Analytics or Plausible (privacy-focused)
Track: Vocab added, reviews completed, retention

### Logging
- Structured (JSON)
- Levels: error, warn, info, debug
- Never log PII/passwords

## Performance Monitoring
- RUM: Vercel Analytics, Web Vitals
- Synthetic: Lighthouse CI on deploy

### Performance Budget
```
Main bundle: < 200KB gzipped
Total page: < 1MB
LCP: < 2.5s, FID: < 100ms, CLS: < 0.1
```

## Pre-Deploy Checklist
- [ ] Lighthouse 90+
- [ ] Core Web Vitals green
- [ ] Images optimized
- [ ] Fonts self-hosted
- [ ] Code split
- [ ] Bundle analyzed
- [ ] Service worker set
- [ ] Queries indexed
- [ ] API < 500ms
- [ ] No console.logs
- [ ] Error tracking on
- [ ] Security headers (CSP, HSTS)
- [ ] HTTPS enforced
- [ ] Env vars secured
- [ ] Dependencies audited
- [ ] RLS tested
- [ ] Rate limiting on
- [ ] Monitoring set
